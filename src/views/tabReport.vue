<template>
  <div class="page">
    <div class="page_hd">
      <mt-header   :title="$route.meta && $route.meta.title"></mt-header>
    </div>
    <div class="page_sub_hd">
      <mt-navbar v-model="selected">
        <mt-tab-item id="1">集团统计</mt-tab-item>
        <mt-tab-item id="2">单个项目统计</mt-tab-item>
      </mt-navbar>
    </div>
    <div class="page_bd">
      <mt-tab-container v-model="selected">
        <mt-tab-container-item id="1">
         <div class="padding15">
            <div  @click="routeTo(item)" v-for="(item, index) in leftList" :key="index" class="weui-flex flex_center padding15 margin-bottom" style="border-radius:5px;height:80px;background:#FFF;">
              <div class="weui-flex__item item_center">
                <p>
                  <img style="height:40px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMmYyNGM3Ny05OWQ4LThmNGMtODg5OC04NGZkNDMyZTBkZWUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzY1NDVFQzAyRkUyMTFFNzhFMzFGMUUxQzVDMTIyQzIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzY1NDVFQkYyRkUyMTFFNzhFMzFGMUUxQzVDMTIyQzIiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6ZDk3NjBlMjktNDlmNi02NDQzLWI4MzktMjU0OTVmMjg0ZDA0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIyZjI0Yzc3LTk5ZDgtOGY0Yy04ODk4LTg0ZmQ0MzJlMGRlZSIv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" />
                  <span class="padding-left main_text">{{item.name}}</span>
                </p>
              </div>
              <div v-for="(sub,subIndex) in item.value" :key="subIndex" class="right_text_item flex_center item_center " >
                <p class="num_text text-center">{{sub.value}}</p>
                <p class="sub_text text-center">{{sub.name}}</p>
              </div>
            </div>
          </div>
        </mt-tab-container-item>
        <mt-tab-container-item id="2">
          <div class="padding15">
            <div @click="routeTo(item)" v-for="(item, index) in rightList" :key="index" class="weui-flex flex_center padding15 margin-bottom" style="border-radius:5px;height:80px;background:#FFF;">
              <div class="weui-flex__item item_center">
                <p>
                  <img style="height:40px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMmYyNGM3Ny05OWQ4LThmNGMtODg5OC04NGZkNDMyZTBkZWUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzY1NDVFQzAyRkUyMTFFNzhFMzFGMUUxQzVDMTIyQzIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzY1NDVFQkYyRkUyMTFFNzhFMzFGMUUxQzVDMTIyQzIiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6ZDk3NjBlMjktNDlmNi02NDQzLWI4MzktMjU0OTVmMjg0ZDA0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIyZjI0Yzc3LTk5ZDgtOGY0Yy04ODk4LTg0ZmQ0MzJlMGRlZSIv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" />
                  <span class="padding-left main_text">{{item.name}}</span>
                </p>
              </div>
              <div v-for="(sub,subIndex) in item.value" :key="subIndex" class="right_text_item flex_center item_center " >
                <p class="num_text text-center">{{sub.value}}<span v-html="sub.unit"></span></p>
                <p class="sub_text text-center">{{sub.name}}</p>
              </div>
            </div>
          </div>
        </mt-tab-container-item>
      </mt-tab-container>
    </div>
  </div>
</template>

<script>
import {mapGetters} from 'Vuex'
export default {
  name: 'tabReport',
  data () {
    return {
      selected: '2',
      currRand: 0,
      leftList: [],
      rightList: []
    }
  },
  created () {
    this.getPageData()
  },
  activated () {
    console.log(this.user, 'user')
    // 当切换职位或项目之后重新调用更新数据
    if (this.currRand !== 0 && this.currRand !== this.rand) {
      this.getPageData && this.getPageData()
      this.currRand = this.rand
    } else {
      this.currRand = this.rand
    }
  },
  computed: {
    ...mapGetters({
      'user': 'user',
      'rand': 'rand'
    })
  },
  methods: {
    async getPageData () {
      let res = await this.getReportAuth()
      if (!res) {
        // 显示空
        return
      }
      console.log(res)
      let arr = await Promise.all([this.rightInfo(), this.leftTopInfo(), this.leftbottomInfo()])
      console.log(arr, 'arr')
      // arr[0]
      this.rightList.forEach((item, index) => {
        item.value = arr[0][index]
      })
      let leftValues = arr[1].concat(arr[2])
      console.log(leftValues, 'arr111111111')
      console.log(this.leftList, '-----')
      this.leftList.forEach((item, index) => {
        item.value = leftValues[index]
      })
      console.log(this.rightList, this.leftList, 'wo qu')
      // this.leftList.forEach((item, index) => {
      // })
    },
    routeTo (item) {
      this.$router.forward({name: item.urlName})
    },
    // 获取报表权限
    async getReportAuth () {
      console.log(this.user, '///-222222222222222222223--')
      let p7 = {
        UserId: this.user.UserID,
        PositionId: this.user.PositionID
      }
      console.log(p7)
      let res = await this.$xml('UserSL_ReportRight', p7)
      console.log(res)
      if (!res.data) return
      let resData = res.data.ReportRight
      let leftArr = [
        {name: '建筑面积', urlName: 'report_building', color: '#41BFE9', icon: 'icon-jianzhu', auth: 'SL_APP_ReportBudArea', value: []},
        {name: '收入分析', urlName: 'report_income', color: '#FA7466', icon: 'icon-shouru', auth: 'SL_APP_ReportFee', value: []},
        {name: '租赁分析', urlName: 'report_rent', color: '#0DC8BD', icon: 'icon-zulinhetong-', auth: 'SL_APP_ReportRent', value: []},
        {name: '特色园分析', urlName: 'report_features', color: '#FCB546', icon: 'icon-fenxi', auth: 'SL_APP_ReportTSY', value: []},
        {name: '租金', urlName: 'report_rentCash', color: '#41BFE9', icon: 'icon-shoukuan', auth: 'JLT_APP_ReportRentReprises', value: []},
        {name: '出租率', urlName: 'report_rentRate', color: '#FA7466', icon: 'icon-chuzu', auth: 'JLT_APP_ReportRentRentalRate', value: []}
      ]
      let rightArr = [
        {name: '客服服务', urlName: 'report_customer', color: '#46A9FC', icon: 'icon-kehufuwu', auth: 'APP_ReportWork', value: []},
        {name: '设备管理', urlName: 'report_device', color: '#FA8A2C', icon: 'icon-shebeiguanli', auth: 'APP_ReportEquip', value: []},
        {name: '项目收款', urlName: 'report_cash', color: '#0DC88C', icon: 'icon-shoukuan', auth: 'APP_ReportCollection', value: []},
        {name: '项目出租', urlName: 'report_lease', color: '#FCBA46', icon: 'icon-chuzu', auth: 'APP_ReportRent', value: []}
      ]
      leftArr.forEach(item => {
        item.show = resData.some(sub => sub.Content === item.auth)
      })
      rightArr.forEach(item => {
        item.show = resData.some(sub => sub.Content === item.auth)
      })
      this.leftList = leftArr
      this.rightList = rightArr
      console.log(this.rightList, this.leftList)
      return true
    },
    // 右侧的内容
    async rightInfo () {
      let res = await this.$xml('UserCS_ReportGlobalReport', {
        orgID: this.user.OrgID,
        financeDate: (new Date()).format('yyyy-MM')
      })
      console.log(res.data, '---right--')
      let arr = res.data
      console.log(arr)
      let values = [
        [{name: '满意度', value: this.formatNum(arr[0].VisitRate), unit: '<span class="unit_text">分</span>'}, {name: '关闭率', value: this.formatNum(arr[0].CloseRate), unit: '%'}],
        [{name: '设备完好率', value: this.formatNum(arr[1].EquiRate), unit: '%'}],
        [{name: '本月帐期已收', value: this.formatNum((arr[2].PaidMoney)), unit: '<span class="unit_text">万元</span>'}, {name: '收缴率', value: this.formatNum(arr[2].PaidRate), unit: '%'}],
        [{name: '出租数量', value: arr[3].HouseCount, unit: '<span class="unit_text">套</span>'}, {name: '出租率', value: this.formatNum(arr[3].CZRate), unit: '%'}]
      ]
      return values
    },
    // 左侧上方的内容
    async leftTopInfo () {
      let res = await this.$xml('UserSL_Summery', {})
      console.log(res, '----')
      let resData = res.data.Summery[0]
      console.log(resData, 'Summery')
      let values = [
        [{name: '管理面积', value: this.formatNum(resData['BudArea']), unit: '%'}],
        [{name: '当月应收', value: this.formatNum(resData['PriPaid']), unit: '%'}],
        [{name: '已出租面积', value: this.formatNum(resData['RentArea']), unit: '%'}],
        [{name: '平均租金', value: this.formatNum(resData['AvgPaid']), unit: '%'}]
      ]
      return values
    },
    formatNum (numStr) {
      if (numStr) {
        return (numStr - 0).toFixed(2)
      } else {
        return '0.00'
      }
    },
    // 左侧下方的内容
    async leftbottomInfo () {
      let res = await this.$xml('UserCS_ReportLeaseSituation', {
        OrgID: this.user.OrgID,
        Etime: (new Date()).format('yyyy-MM-dd')
      })
      let data = res.data.pop()
      let values = [
        [{name: '实际租金', value: this.formatNum(data.ZJmoney)}, {name: '目标租金', value: this.formatNum(data.MSR)}],
        [{name: '实际出租率', value: this.formatNum(data.CZL), unit: '%'}, {name: '目标出租率', value: this.formatNum(data.MCZL), unit: '%'}]
      ]
      return values
    }
  }
}
</script>
<style lang="scss">
.unit_text {
  font-size:.28rem;
  color:#999;
}
</style>
<style scoped>
.mint-navbar .mint-tab-item.is-selected{
  border-bottom:none;
}
.sub_text {
  color: #999;
  font-size: 0.3rem;
}
.main_text {
  color:#333;
  font-size:.34rem;
}
.num_text {
  color:#FA8A2C;
  font-size: 0.34rem;
}

.right_text_item + .right_text_item {
  padding-left:10px
}
</style>
