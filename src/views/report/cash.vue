<template>
  <div class="page">
    <mt-header  title="项目收款">
      <mt-button slot="left" @click="$router.back()" icon="back">返回</mt-button>
    </mt-header>
    <div class="weui-cells" style="margin:0;">
      <a class="weui-cell weui-cell_access" @click="$router.push({name: 'report_cash_change'})" href="javascript:;">
          <div class="weui-cell__bd">
              <p>{{orgName}}</p>
          </div>
          <div class="weui-cell__ft"></div>
      </a>
    </div>
    <div class="page_bd">
      <div class="weui-form-preview margin-bottom" style="margin-top:-1px;">
        <div class="weui-form-preview__hd text-center">
          <a>2018-06-12</a>
        </div>
        <div class="weui-form-preview__bd" style="background: #3395FF;">
          <div class="map_bl" ref="map1"></div>
        </div>
        <div class="weui-form-preview__ft">
            <div class="weui-form-preview__btn weui-form-preview__btn_default" >应收: 283089.61</div>
            <div class="weui-form-preview__btn weui-form-preview__btn_default" >收缴率: 0</div>
        </div>
      </div>

      <div class="weui-form-preview  margin-bottom" >
          <div class="weui-form-preview__hd">
            <div class="weui-form-preview__item">
                <label class="weui-form-preview__label">实收分布</label>
                <label v-if="dataReady" class="weui-form-preview__value"></label>
            </div>
          </div>
          <div class="weui-form-preview__bd">
            <div class="map_bl"  ref="map2"></div>
          </div>
      </div>
      <div class="weui-form-preview  margin-bottom">
          <div class="weui-form-preview__hd">
            <div class="weui-form-preview__item">
                <label class="weui-form-preview__label">分项实收情况</label>
            </div>
          </div>
          <div class="weui-form-preview__bd">
            <div v-if="dataReady" class="fs14">
              <div class="weui-flex">
                <div class="bold weui-flex__item text-center">费项</div>
                <div class="bold weui-flex__item text-center">应收</div>
                <div class="bold weui-flex__item text-center">实收</div>
                <div class="bold weui-flex__item text-center">收缴率</div>
              </div>
              <div class="weui-flex" v-for="(item,index) in list3" :key="index">
                <div class="weui-flex__item text-center dark_33 overhidden">{{item.IPItemName}}</div>
                <div class="weui-flex__item text-center dark_33">{{item.PriRevMoney | float2}}</div>
                <div class="weui-flex__item text-center dark_33">{{item.PaidMoney | float2}}</div>
                <div class="weui-flex__item text-center dark_33">{{item.TradingRate | float2 }}%</div>
              </div>
            </div>
          </div>
      </div>

    </div>
    <transition name="page">
      <keep-alive>
        <router-view/>
      </keep-alive>
    </transition>
  </div>
</template>
<script>
import {mapGetters} from 'Vuex'
import mapReady from '@/utils/getEchars'
import {option1, option2} from './child/cashMap'
export default {
  name: 'cash',
  data () {
    return {
      orgName: '',
      list3: [],
      dataReady: false
    }
  },
  created () {
    console.log(this.user, 'user--')
    this.orgId = this.user.OrgID
    this.orgName = this.user.OrgName
    this.getPageData()
  },
  computed: {
    ...mapGetters({
      'user': 'user'
    })
  },
  methods: {
    async getPageData () {
      let arr = await Promise.all([this.getData1(), this.getData2(), this.getData3(), mapReady()])
      console.log(arr, '结果')
      let echarts = arr[3]
      this.map1 = echarts.init(this.$refs.map1)
      this.map2 = echarts.init(this.$refs.map2)
      this.list3 = arr[2].sort((a, b) => {
        return (b.PriRevMoney - 0) - (a.PriRevMoney - 0)
      })
      this.dataMap1(arr[0])
      this.dataMap2(arr[1])
      this.dataReady = true
    },
    // 财务收缴率报表
    async getData1 () {
      let p0 = 'UserCS_ReportConfiscateRate'
      let res = await this.$xml(p0, {
        orgID: this.orgId,
        financeDate: '2018-08'
      })
      return res.data
    },
    // 财务实收分布报表
    async getData2 () {
      let p0 = 'UserCS_ReportFnPaidTrading'
      let res = await this.$xml(p0, {
        orgID: this.orgId,
        financeDate: '2018-08'
      })
      return res.data
    },
    // 财务分项实收情况报表
    async getData3 () {
      let p0 = 'UserCS_ReportFnPaidSituation'
      let res = await this.$xml(p0, {
        orgID: this.orgId,
        financeDate: '2018-08'
      })
      return res.data
    },
    dataMap1 (data) {
      let white = '#FFF'
      let num = data[0].TradingRate
      option1.series[0].axisLine.lineStyle.color = [[0, white], [(num / 100), white], [1, 'rgba(251, 212, 55, 0.3)']]
      option1.series[0].data = [{value: num, name: '收缴率'}]
      this.map1.setOption(option1)
    },
    dataMap2 (data) {
      let temp1 = []
      let temp2 = []
      for (var i = 0; i < data.length; i++) {
        var name = data[i].IPItemName
        var rate = data[i].IPItemNameRate
        var formatRate = Math.floor(rate * 100) / 100
        temp1.push(name)
        temp2.push({
          name: name,
          value: formatRate
        })
      }
      if (temp1.length > 0) {
        option2.legend.data = temp1
        option2.series[0].data = temp2
      } else {
        option2.legend.data = ['无实收']
        option2.series[0].data = [
          {
            value: 0,
            name: '无实收'
          }
        ]
      }
      this.map2.setOption(option2)
    }
  }
}
</script>
<style lang="scss" scoped>
.page_bd {
  .map_bl {
    height:170px;
  }
  .weui-form-preview {
    .weui-form-preview__hd {
      padding: 5px 15px;
    }
    .weui-form-preview__label {
      font-size:16px;
      color:#333;
    }
    .weui-form-preview__value {
      font-size:16px;
    }
  }
}
</style>
